<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeRoute AI - Safety Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #toast-notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
         /* Style for the new Autocomplete */
        gmp-place-autocomplete {
            width: 100%;
            position: relative;
        }
        input.pac-input {
             width: 100% !important;
             background-color: #374151 !important; /* gray-700 */
             color: #F3F4F6 !important; /* gray-100 */
             padding: 0.5rem !important;
             border-radius: 0.375rem !important; /* rounded-md */
             border: 1px solid #4B5563 !important; /* gray-600 */
        }
        /* Base style for all report markers */
        .report-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        /* Brighter Color for Harassment/Incident reports (Red) */
        .marker-incident {
            background-color: rgba(239, 68, 68, 0.85); /* Increased opacity */
            box-shadow: 0 0 20px 12px rgba(239, 68, 68, 0.75); /* More focused glow */
        }

        /* Brighter Color for Poorly Lit reports (Yellow) */
        .marker-unlit {
            background-color: rgba(234, 179, 8, 0.85); /* Increased opacity */
            box-shadow: 0 0 20px 12px rgba(234, 179, 8, 0.75); /* More focused glow */
        }

        /* Brighter Color for Too Crowded reports (Blue) */
        .marker-crowded {
            background-color: rgba(59, 130, 246, 0.85); /* Increased opacity */
            box-shadow: 0 0 20px 12px rgba(59, 130, 246, 0.75); /* More focused glow */
        }

        /* Brighter Color for All Safe reports (Green) */
        .marker-safe {
            background-color: rgba(34, 197, 94, 0.85); /* Increased opacity */
            box-shadow: 0 0 20px 12px rgba(34, 197, 94, 0.75); /* More focused glow */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="map"></div>
    <div class="absolute bottom-8 right-8 z-10 bg-gray-800 bg-opacity-80 backdrop-blur-sm p-4 rounded-lg shadow-lg text-white w-52">
        <h3 class="text-md font-bold mb-3 text-center border-b border-gray-700 pb-2">Risk-Indicators</h3>
        <div class="space-y-3 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-3 shrink-0 marker-incident"></div>
                <span>Harassment/Incident</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-3 shrink-0 marker-unlit"></div>
                <span>Poorly Lit</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-3 shrink-0 marker-crowded"></div>
                <span>Too Crowded</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full mr-3 shrink-0 marker-safe"></div>
                <span>All Safe</span>
            </div>
        </div>
    </div>
    
    <!-- API Key Warning -->
    <div id="apiKeyWarning" class="hidden absolute inset-0 z-20 bg-gray-900 bg-opacity-90 flex items-center justify-center text-center p-8">
        <div>
            <h2 class="text-3xl font-bold text-red-500 mb-4">Configuration Error</h2>
            <p class="text-lg text-gray-300 mb-2">Your Google Maps API key or Map ID is missing/invalid.</p>
            <p class="text-md text-gray-400">Please replace <code class="bg-gray-700 text-yellow-400 p-1 rounded">'YOUR_API_KEY'</code> and <code class="bg-gray-700 text-yellow-400 p-1 rounded">'YOUR_MAP_ID'</code> in the code.</p>
        </div>
    </div>

    <!-- Main UI Panel -->
<div class="absolute top-4 left-4 z-10 w-full max-w-sm">
    <div class="bg-gray-800 rounded-xl shadow-lg p-4">
        <h1 class="text-xl font-bold text-center text-white">City-Sakhi</h1>
        
        <div class="mt-4 space-y-2">
            <div class="relative">
                <input id="start-input" type="text" placeholder="Enter starting point" class="w-full bg-gray-700 text-gray-100 p-2 rounded-md border border-gray-600 focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="relative">
                <input id="end-input" type="text" placeholder="Enter destination" class="w-full bg-gray-700 text-gray-100 p-2 rounded-md border border-gray-600 focus:border-indigo-500 focus:outline-none">
            </div>
        </div>
        
        <button id="get-route-btn" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition">Find Safest Route</button>

        <div id="route-info" class="hidden mt-4 text-center bg-gray-700 p-4 rounded-lg shadow-inner">
            <p class="text-lg text-gray-200">Overall Safest Route Score:</p>
            <p id="safety-score" class="text-4xl font-extrabold"></p>
            <p id="safety-level" class="text-md font-medium"></p>

            <div id="route-details" class="mt-4 pt-4 border-t border-gray-600 text-left space-y-2 text-gray-300 text-sm">
                <p id="route-distance"></p>
                <p><strong>By Car:</strong> <span id="duration-driving" class="float-right">--</span></p>
                <p><strong>By Bike:</strong> <span id="duration-bicycling" class="float-right">--</span></p>
                <p><strong>By Transit:</strong> <span id="duration-transit" class="float-right">--</span></p>
                <p><strong>By Walking:</strong> <span id="duration-walking" class="float-right">--</span></p>
            </div>
        </div>
    </div>
</div>

   
    <!-- Check-in Modal -->
    <div id="checkInModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-30">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">Report a Situation</h2>
            <div class="grid grid-cols-1 gap-4">
                <button data-report-type="safe" class="report-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">All Safe</button>
                <button data-report-type="unlit" class="report-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg">Poorly Lit</button>
                <button data-report-type="crowded" class="report-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Too Crowded</button>
                <button data-report-type="incident" class="report-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg">Harassment/Incident</button>
            </div>
            <button id="closeModalBtn" class="w-full mt-6 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="absolute bottom-8 left-1/2 -translate-x-1/2 z-40 bg-gray-700 text-white py-2 px-5 rounded-lg shadow-lg">
        <span id="toast-message"></span>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtVQEq_10-a7mWd4oaXgKFk1TRhqZcGY8&libraries=places,geometry,marker&v=beta"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, GeoPoint } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbQrJCnNISZqrKrlyDSt7oLz558Um9DTM",
            authDomain: "saferoute-ai-685e3.firebaseapp.com",
            projectId: "saferoute-ai-685e3",
            storageBucket: "saferoute-ai-685e3.appspot.com",
            messagingSenderId: "874452490466",
            appId: "1:874452490466:web:077ba705107e0766b366bb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Variables
        let map;
        let userMarker;
        let currentPosition = null;
        let dangerPoints = [];
        let directionsService;
        let routeRenderers = [];
        let debugMarkers = [];
        let isSafetyDataLoaded = false;
        let Map, AdvancedMarkerElement;
        
        // Store selected places and autocomplete instances
        let startAutocomplete, endAutocomplete;
        let selectedStartPlace = null;
        let selectedEndPlace = null;

        // Function Definitions
        function checkApiKey() {
            const scriptSrc = document.querySelector('script[src*="maps.googleapis.com"]').src;
            const mapId = map?.getMapId();
            if (scriptSrc.includes("YOUR_API_KEY") || !mapId || mapId === 'YOUR_MAP_ID') {
                document.getElementById('apiKeyWarning').classList.remove('hidden');
                return false;
            }
            return true;
        }

        async function init() {
            ({ Map } = await google.maps.importLibrary("maps"));
            ({ AdvancedMarkerElement } = await google.maps.importLibrary("marker"));
           
            map = new Map(document.getElementById("map"), {
                center: { lat: 16.5062, lng: 80.6480 },
                zoom: 14,
                disableDefaultUI: true,
                mapId: 'd332a2b5e985ab1d6a686ae4',
            });

            if (!checkApiKey()) return;
           
            directionsService = new google.maps.DirectionsService();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
                        const markerIcon = document.createElement('div');
                            // Apply the base report-marker class for size/shape, and the blue specific class
                            markerIcon.className = 'report-marker marker-crowded'; // Using the 'marker-crowded' style
                            userMarker = new AdvancedMarkerElement({
                                position: currentPosition,
                                map: map,
                                title: "Your Location",
                                content: markerIcon
                            });
                    },
                    () => { console.log("Geolocation service failed."); }
                );
            }
           
            initializeHeatmap();
            setupRouting();
            
            // Setup autocomplete after a short delay to ensure DOM is ready
            setTimeout(() => {
                setupAutocompleteListeners();
            }, 100);
        }

        function setupAutocompleteListeners() {
            // Create traditional Google Places Autocomplete instances
            const startInput = document.getElementById('start-input');
            const endInput = document.getElementById('end-input');

            startAutocomplete = new google.maps.places.Autocomplete(startInput);
            endAutocomplete = new google.maps.places.Autocomplete(endInput);

            // Set bias to current location if available
            if (currentPosition) {
                const circle = new google.maps.Circle({
                    center: currentPosition,
                    radius: 10000 // 10km radius
                });
                startAutocomplete.setBounds(circle.getBounds());
                endAutocomplete.setBounds(circle.getBounds());
            }

            // Add event listeners for place selection
            startAutocomplete.addListener('place_changed', () => {
                selectedStartPlace = startAutocomplete.getPlace();
                console.log('Start place selected:', selectedStartPlace);
                
                if (!selectedStartPlace.geometry) {
                    console.log('No details available for start location');
                    return;
                }
            });

            endAutocomplete.addListener('place_changed', () => {
                selectedEndPlace = endAutocomplete.getPlace();
                console.log('End place selected:', selectedEndPlace);
                
                if (!selectedEndPlace.geometry) {
                    console.log('No details available for end location');
                    return;
                }
            });
        }

        function setupRouting() {
            const getRouteBtn = document.getElementById('get-route-btn');
            getRouteBtn.addEventListener('click', calculateAndDisplayRoute);
        }

async function calculateAndDisplayRoute() {
    if (!isSafetyDataLoaded) {
        showToast("Safety data is loading, please try again in a moment.", true);
        return;
    }
    
    routeRenderers.forEach(renderer => renderer.setMap(null));
    routeRenderers = [];

    if (!selectedStartPlace || !selectedStartPlace.geometry || !selectedEndPlace || !selectedEndPlace.geometry) {
        showToast("Please select valid start and end locations from the dropdown.", true);
        return;
    }

    // --- Clear UI and RESET styles for new calculation ---
    ['driving', 'bicycling', 'transit', 'walking'].forEach(mode => {
        const durationSpan = document.getElementById(`duration-${mode}`);
        if (durationSpan) {
            durationSpan.textContent = 'Calculating...';
            durationSpan.parentElement.classList.remove('text-gray-500');
        }
    });

    const origin = selectedStartPlace.geometry.location;
    const destination = selectedEndPlace.geometry.location;

    // --- Step 1: Get all alternative WALKING routes to draw on the map ---
    try {
        const response = await new Promise((resolve, reject) => {
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: 'WALKING',
                provideRouteAlternatives: true
            }, (res, status) => (status === 'OK') ? resolve(res) : reject(status));
        });

        let safestRoute = null;
        let maxScore = -1;
        const scoredRoutes = [];

        response.routes.forEach(route => {
            const score = scoreRoute(route);
            scoredRoutes.push({ route, score });
            if (score > maxScore) {
                maxScore = score;
                safestRoute = route;
            }
        });

        // Render each walking route with risk-based coloring
        scoredRoutes.forEach(({ route, score }) => {
            let strokeColor = '#4F46E5'; // Default Blue for low-risk alternatives
            let strokeWeight = 6;
            let zIndex = 1;

            if (score < 50) {
                strokeColor = '#EF4444'; // Red for High Risk
            } else if (score < 80) {
                strokeColor = '#F59E0B'; // Yellow for Moderate Risk
            }

            if (route === safestRoute) {
                strokeColor = '#059669'; // Bright Green for the safest route
                strokeWeight = 8;
                zIndex = 10; // Make sure the safest route is drawn on top
            }

            const renderer = new google.maps.DirectionsRenderer({
                map: map,
                directions: response,
                routeIndex: response.routes.indexOf(route),
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: strokeColor,
                    strokeWeight: strokeWeight,
                    strokeOpacity: 0.9,
                    zIndex: zIndex
                }
            });
            routeRenderers.push(renderer);
        });

        if (safestRoute) {
            updateRouteUI(maxScore, safestRoute);
        }

    } catch (e) {
        showToast("Could not find any walking routes.", true);
    }

    // --- Step 2: Get durations for ALL travel modes for the info box ---
    const getDuration = async (mode) => {
        try {
            const response = await new Promise((resolve, reject) => {
                directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: mode,
                }, (res, status) => (status === 'OK') ? resolve(res) : reject(status));
            });
            return response.routes[0].legs[0].duration.text;
        } catch (e) {
            return 'No route found';
        }
    };
    
    // Fetch and update each duration in the info panel
    const modesToFetch = ['driving', 'bicycling', 'transit', 'walking'];
    for (const mode of modesToFetch) {
        const duration = await getDuration(mode.toUpperCase());
        const durationSpan = document.getElementById(`duration-${mode}`);
        if (durationSpan) {
            durationSpan.textContent = duration;
            if (duration === 'No route found') {
                durationSpan.parentElement.classList.add('text-gray-500');
            }
        }
    }
}
       
function scoreRoute(route) {
    let dangerScore = 0;
    
    // Create a Google Maps Polyline object from the route's path
    const routePolyline = new google.maps.Polyline({ path: route.overview_path });

    // This value represents the 'danger density' at which a route is considered 100% unsafe.
    // For example, a value of 10 means a route with an average of two major incidents (weight=5) 
    // per kilometer will have a score of 0.
    // **You can adjust this value to make the scoring more or less strict.**
    const MAX_DANGER_DENSITY = 10;

    dangerPoints.forEach(point => {
        // Use a built-in Maps function to check if a danger point is on or near the route line.
        // The tolerance (in meters) defines how close it needs to be. Let's use 250m for more precision.
        if (google.maps.geometry.poly.isLocationOnEdge(point.location, routePolyline, 250)) {
            dangerScore += point.weight;
        }
    });

    // Normalize the danger score by the route's length in kilometers.
    // This prevents longer routes from being unfairly penalized.
    const routeLengthKm = route.legs[0].distance.value / 1000;

    if (routeLengthKm > 0) {
        const dangerDensity = dangerScore / routeLengthKm;
        
        // Convert the danger density into a safety score from 0 to 100
        const safetyPercentage = Math.max(0, 1 - (dangerDensity / MAX_DANGER_DENSITY));
        const finalSafetyScore = Math.round(safetyPercentage * 100);
        
        return finalSafetyScore;
    }

    return 100; // If the route has no length, it's safe by default.
}

function updateRouteUI(score, route) {
    const routeInfo = document.getElementById('route-info');
    const safetyScoreEl = document.getElementById('safety-score');
    const safetyLevelEl = document.getElementById('safety-level');
    const distanceEl = document.getElementById('route-distance');
    
    safetyScoreEl.textContent = score; // This is now 0-100

    // Set risk level based on the new 0-100 safety score
    if (score >= 80) {
        safetyLevelEl.textContent = "Low Risk";
        safetyLevelEl.className = "text-green-400 font-medium";
    } else if (score >= 50) {
        safetyLevelEl.textContent = "Moderate Risk";
        safetyLevelEl.className = "text-yellow-400 font-medium";
    } else {
        safetyLevelEl.textContent = "High Risk";
        safetyLevelEl.className = "text-red-400 font-medium";
    }

    if (route && route.legs && route.legs.length > 0) {
        const leg = route.legs[0];
        distanceEl.textContent = `Distance: ${leg.distance.text}`;
    }
    routeInfo.classList.remove('hidden');
}

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `absolute bottom-8 left-1/2 -translate-x-1/2 z-40 text-white py-2 px-5 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-gray-700'} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

function initializeHeatmap() {
    const q = query(collection(db, "checkins"));

    console.log("Attaching Firestore listener...");

    onSnapshot(q, (snapshot) => {
        console.log("onSnapshot callback fired.");
        console.log(`Snapshot contains ${snapshot.size} documents.`);

        dangerPoints = [];
        debugMarkers.forEach(marker => marker.setMap(null));
        debugMarkers = [];

        snapshot.forEach((doc) => {
            console.log("Processing doc:", doc.id, doc.data());
            const data = doc.data();
            const lat = data.Location?.lat || data.location?.lat;
            const lng = data.Location?.lng || data.location?.lng;

            if (lat && lng) {
                const latLng = new google.maps.LatLng(lat, lng);

                let weight = 0;
                let markerClass = 'report-marker'; // Start with the base class

                switch (data.type) {
                    case 'incident':
                        weight = 5;
                        markerClass += ' marker-incident'; // Add red class
                        break;
                    case 'unlit':
                        weight = 3;
                        markerClass += ' marker-unlit'; // Add yellow class
                        break;
                    case 'crowded':
                        weight = 1;
                        markerClass += ' marker-crowded'; // Add blue class
                        break;
                    case 'safe':
                        // No weight for routing, but we'll still show a green marker
                        markerClass += ' marker-safe'; // Add green class
                        break;
                }

                if (data.type) { // Create a marker for any valid report type
                    dangerPoints.push({ location: latLng, weight: weight });

                    const markerIcon = document.createElement('div');
                    markerIcon.className = markerClass; // Apply the correct classes

                    const marker = new AdvancedMarkerElement({
                        position: latLng,
                        map: map,
                        title: `Type: ${data.type}, Weight: ${weight}`,
                        content: markerIcon
                    });
                    debugMarkers.push(marker);
                }
            } else {
                console.warn("Doc missing location data:", doc.id);
            }
        });

        console.log("Finished processing all documents.");
        isSafetyDataLoaded = true;
        console.log("Safety data loaded and processed. Ready for routing.");
    }, (error) => {
        console.error("Firestore snapshot error: ", error);
    });
}
       
        // Start the Application
        init();
    </script>
</body>
</html>